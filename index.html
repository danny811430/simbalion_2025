<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>色軌｜手掌雙筆流星軌跡（低配＋抗鋸齒＋隨機底圖）</title>
  <style>
    :root{ --bg0:#020409; --bg1:#081224; --fg:#eaf6ff; --muted:#a8b9c5; --bdr:#1b2530; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:radial-gradient(1200px 800px at 70% 20%, var(--bg1), var(--bg0) 60%, #000); color:var(--fg); font-family:ui-sans-serif, system-ui, -apple-system}
    header{position:fixed; left:16px; top:16px; z-index:20}
    .brand{letter-spacing:.12em; font-weight:700; font-size:14px; color:var(--muted)}
    .brand b{color:#7fe3ff}

    .toolbar{position:fixed; right:16px; top:16px; z-index:30; width:360px; background:linear-gradient(180deg,#0e131a,#0a0d12); border:1px solid var(--bdr); border-radius:14px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .toolbar h2{margin:0 0 8px 0; font-size:14px; color:#cfe2ef; letter-spacing:.04em}
    .row{display:flex; align-items:center; gap:8px; margin:8px 0}
    .row label{width:120px; color:#c0d0da; font-size:12px}
    select, button, input[type="range"], input[type="checkbox"]{flex:1; background:#121820; color:var(--fg); border:1px solid #1d2833; border-radius:10px; padding:8px 10px; font-size:12px}
    button{cursor:pointer}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; border:1px solid #2b2b2b; background:#121212; color:#a8b0b3; font-size:11px}
    .dot{width:8px; height:8px; border-radius:50%; background:#666}
    .dot.on{background:#57d38a}
    .stage{position:fixed; inset:0; display:grid; place-items:center}
    canvas{width:100vw; height:100vh; display:block; background:#000}
    video{display:none}
    .hint{position:fixed; left:50%; bottom:28px; transform:translateX(-50%); color:#b4bdc1; background:#071015aa; border:1px solid #13303a; padding:8px 12px; border-radius:999px; font-size:12px; backdrop-filter: blur(6px)}

    /* 乾淨全螢幕：隱藏所有 UI/info */
    .clean header, .clean .toolbar, .clean .hint, .clean .badge, .clean .brand{ display:none !important; }
    .clean{ cursor:none; }
  </style>
</head>
<body>
  <header><div class="brand"><b>COLOR TRAIL</b> · 手掌雙筆流星軌跡（AA + 隨機底圖）</div></header>

  <div class="toolbar" role="region" aria-label="控制面板">
    <h2>控制面板</h2>
    <div class="row"><label>攝影機</label><span class="badge"><span id="camDot" class="dot"></span>Camera</span><span id="fps" class="badge">FPS: --</span><span id="det" class="badge">Hands: 0</span></div>
    <div class="row"><label>亮色主題</label>
      <select id="theme">
        <option value="neon">Neon（黃/綠/青/粉）</option>
        <option value="lime">Lime（螢光綠）</option>
        <option value="sun">Sun（螢光黃橙）</option>
        <option value="aqua">Aqua（青藍電光）</option>
      </select>
    </div>
    <div class="row"><label>軌跡粗細</label><input id="thick" type="range" min="2" max="44" step="0.5" value="16"/></div>
    <div class="row"><label>發光強度</label><input id="glow" type="range" min="0" max="1" step="0.01" value="0.75"/></div>
    <div class="row"><label>消退速度</label><input id="fade" type="range" min="0.85" max="0.995" step="0.001" value="0.975"/></div>
    <div class="row"><label>軌跡長度</label><input id="trailLen" type="range" min="1" max="10" step="1" value="7"/></div>
    <div class="row"><label>抗鋸齒</label>
      <select id="aa">
        <option value="1">一般（省資源）</option>
        <option value="1.5" selected>1.5x 超取樣</option>
        <option value="2">2x 超取樣</option>
      </select>
    </div>
    <div class="row"><label>隨機底圖</label>
      <div style="display:flex; gap:8px; align-items:center; flex:1">
        <label style="display:flex; gap:6px; align-items:center"><input id="ambientOn" type="checkbox" checked/> 開啟</label>
        <label style="display:flex; gap:6px; align-items:center"><input id="ambientFade" type="checkbox" checked/> 有人時淡出</label>
      </div>
    </div>
    <div class="row"><label>操作</label><button id="start">啟動攝影機</button><button id="clear">清空</button><button id="save">存圖</button></div>
    <div class="row"><label>提示</label><span class="badge">雙擊：全螢幕/退出（乾淨畫面）</span></div>
  </div>

  <div class="stage">
    <canvas id="stage" width="1280" height="720" aria-label="雙筆流星軌跡"></canvas>
    <video id="video" playsinline></video>
  </div>

  <div class="hint">只偵測「雙手手掌中心」，因此最多兩支畫筆。若開啟隨機底圖，入鏡時會自動淡出。</div>

  <script type="module">
    import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3';

    const $ = (s)=>document.querySelector(s);
    const video = $('#video');
    const canvas = $('#stage');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = true;

    const camDot = $('#camDot');
    const fpsBadge = $('#fps');
    const detBadge = $('#det');
    const startBtn = $('#start');
    const clearBtn = $('#clear');
    const saveBtn = $('#save');
    const themeSel = $('#theme');
    const thickRange = $('#thick');
    const glowRange = $('#glow');
    const fadeRange = $('#fade');
    const trailLenRange = $('#trailLen');
    const aaSel = $('#aa');
    const ambientOn = $('#ambientOn');
    const ambientFade = $('#ambientFade');

    // ===== 低配優化 =====
    function fit(){ canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; }
    addEventListener('resize', fit); fit();

    const CAM_CONSTRAINTS = { video:{ width:{ideal:640}, height:{ideal:360}, frameRate:{ideal:30}, facingMode:'user' }, audio:false };
    const INFER_EVERY_N_FRAMES = 1; // 提高可靠度：每幀推論（640x360 足夠輕）

    // 背景層（隨機底圖）
    const bgCanvas = document.createElement('canvas');
    bgCanvas.width = canvas.width; bgCanvas.height = canvas.height;
    const bgCtx = bgCanvas.getContext('2d');
    let bgAlpha = 1; // 0..1
    function drawAmbient(){
      // 幾何隨機線條 + 柔光
      const W=bgCanvas.width, H=bgCanvas.height;
      bgCtx.globalCompositeOperation='source-over';
      bgCtx.fillStyle='rgba(0,0,0,0.08)'; bgCtx.fillRect(0,0,W,H);
      const colors=['#102a43','#0b3a4a','#142b6f','#0c4b6e','#093a2a'];
      for(let i=0;i<4;i++){
        const x0=Math.random()*W, y0=Math.random()*H;
        const x1=Math.random()*W, y1=Math.random()*H;
        bgCtx.save();
        bgCtx.globalAlpha=0.3;
        bgCtx.strokeStyle=colors[(Math.random()*colors.length)|0];
        bgCtx.lineWidth=1+Math.random()*3;
        bgCtx.beginPath();
        bgCtx.moveTo(x0,y0);
        const cx=(x0+x1)/2 + (Math.random()-0.5)*200;
        const cy=(y0+y1)/2 + (Math.random()-0.5)*200;
        bgCtx.quadraticCurveTo(cx,cy,x1,y1);
        bgCtx.stroke();
        bgCtx.restore();
      }
    }

    // 超取樣抗鋸齒的軌跡層（AA 可調）
    let AA = parseFloat(aaSel.value);
    let trailCanvas, trailCtx;
    function rebuildTrailCanvas(){
      AA = parseFloat(aaSel.value);
      trailCanvas = document.createElement('canvas');
      trailCanvas.width = Math.floor(canvas.width*AA);
      trailCanvas.height = Math.floor(canvas.height*AA);
      trailCtx = trailCanvas.getContext('2d');
      trailCtx.imageSmoothingEnabled = true;
    }
    rebuildTrailCanvas();
    aaSel.addEventListener('change', rebuildTrailCanvas);

    // 色盤
    const palettes = {
      neon:["#eaff00","#19ff6d","#18d8ff","#ff6df5"],
      lime:["#a8ff00","#7fff00","#b6ff3b","#d5ff7a"],
      sun:["#fff200","#ffc300","#ffb100","#ffd966"],
      aqua:["#00f7ff","#16d9ff","#3fbfff","#7fe3ff"]
    };
    function colorFor(i){ const pal = palettes[themeSel.value]||palettes.neon; return pal[i%pal.length]; }

    // 兩支筆（左手、右手）
    const MAX_POINTS = 120;
    const pens = [ {points:[], colorIdx:0}, {points:[], colorIdx:1} ];

    function clearAll(){
      ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
      bgCtx.fillStyle='#000'; bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      rebuildTrailCanvas(); pens.forEach(p=>p.points.length=0);
    }
    clearAll();

    function mapPalm(lm){
      const ids=[0,5,9,13,17]; let x=0,y=0; ids.forEach(i=>{x+=lm[i].x; y+=lm[i].y;}); x/=ids.length; y/=ids.length;
      return { x:(1-x)*canvas.width*AA, y:y*canvas.height*AA };// 映射到 AA 層
    }

    // 固定步長重取樣 + 平滑曲線
    function addPoint(pen, pt){
      const arr = pen.points; const step = 10*AA; // AA 越高步長等比
      const last = arr[arr.length-1];
      if(!last){ arr.push(pt); return; }
      const dx = pt.x-last.x, dy = pt.y-last.y; const dist = Math.hypot(dx,dy);
      if(dist < 0.5) return;
      const n = Math.max(1, Math.floor(dist/step));
      for(let i=1;i<=n;i++){ arr.push({x:last.x+dx*i/n, y:last.y+dy*i/n}); }
      const lenFactor = parseInt(trailLenRange.value,10);
      const maxKeep = Math.min(MAX_POINTS, 20 + lenFactor*10); // 30..120
      if(arr.length>maxKeep) arr.splice(0, arr.length-maxKeep);
    }

    function drawRibbon(gctx, pts, color, baseW, glow){
      if(pts.length<2) return;
      gctx.save();
      gctx.lineCap='round'; gctx.lineJoin='round';
      gctx.globalCompositeOperation='lighter';

      // Glow
      if(glow>0){
        gctx.strokeStyle=color; gctx.shadowColor=color; gctx.shadowBlur = baseW*(10*glow+4);
        gctx.lineWidth = baseW*1.5;
        gctx.beginPath();
        let p0=pts[0], p1=pts[1];
        gctx.moveTo(p0.x, p0.y);
        for(let i=1;i<pts.length;i++){
          const midX=(p0.x+p1.x)/2, midY=(p0.y+p1.y)/2;
          gctx.quadraticCurveTo(p0.x, p0.y, midX, midY);
          p0=p1; p1=pts[i+1]; if(!p1){ gctx.quadraticCurveTo(p0.x,p0.y, pts[i].x, pts[i].y); break; }
        }
        gctx.stroke();
      }
      // Core
      gctx.shadowBlur=0; gctx.lineWidth = baseW;
      gctx.strokeStyle=color;
      gctx.beginPath(); let a=pts[0], b=pts[1]; gctx.moveTo(a.x,a.y);
      for(let i=1;i<pts.length;i++){
        const midX=(a.x+b.x)/2, midY=(a.y+b.y)/2;
        gctx.quadraticCurveTo(a.x,a.y, midX,midY);
        a=b; b=pts[i+1]; if(!b){ gctx.quadraticCurveTo(a.x,a.y, pts[i].x, pts[i].y); break; }
      }
      gctx.stroke();
      gctx.restore();
    }

    function fadeTrails(){
      const fade = parseFloat(fadeRange.value);
      const lenFactor = parseInt(trailLenRange.value,10);
      const eff = Math.min(0.995, fade + (lenFactor-5)*0.005);
      trailCtx.save(); trailCtx.globalCompositeOperation='source-over';
      trailCtx.fillStyle = `rgba(0,0,0,${1-eff})`;
      trailCtx.fillRect(0,0,trailCanvas.width,trailCanvas.height);
      trailCtx.restore();
    }

    let landmarker=null, running=false, frameCount=0;

    async function init(){
      const stream = await navigator.mediaDevices.getUserMedia(CAM_CONSTRAINTS);
      video.srcObject = stream; await video.play(); camDot.classList.add('on');
      const resolver = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm');
      landmarker = await HandLandmarker.createFromOptions(resolver, {
        baseOptions: { modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/latest/hand_landmarker.task' },
        runningMode: 'VIDEO',
        numHands: 2,
        minHandDetectionConfidence: 0.4,
        minHandPresenceConfidence: 0.4,
        minTrackingConfidence: 0.4
      });
    }

    function assignHands(hands, handednesses){
      // 回傳 [left,right] 的 landmark；若未知則按索引
      let left=null,right=null;
      if(handednesses && handednesses.length){
        hands.forEach((lm,i)=>{
          const cat = handednesses[i][0]?.categoryName || '';
          if(cat==='Left') left = lm; else if(cat==='Right') right = lm; else if(!left) left=lm; else if(!right) right=lm;
        });
      }
      if(!left && hands[0]) left=hands[0];
      if(!right && hands[1]) right=hands[1];
      return [left,right];
    }

    async function loop(){
      if(!running) return; requestAnimationFrame(loop);
      frameCount++;

      // 背景動畫
      if(ambientOn.checked){ drawAmbient(); }

      // 衰退
      fadeTrails();

      // 推論
      const res = landmarker.detectForVideo(video, performance.now());
      const hands = res?.landmarks || [];
      const [left,right] = assignHands(hands, res?.handednesses);
      const detectedCount = (left?1:0) + (right?1:0);
      detBadge.textContent = 'Hands: ' + detectedCount;

      // 有人則把底圖淡出
      if(ambientFade.checked){ bgAlpha += (detectedCount>0 ? -0.08 : 0.05); bgAlpha = Math.max(0, Math.min(1, bgAlpha)); }

      // 畫兩支筆
      [left,right].forEach((lm, i)=>{
        if(!lm) return;
        const pt = mapPalm(lm);
        addPoint(pens[i], pt);
        const w = parseFloat(thickRange.value)*AA; // AA 對應放大
        const glow = parseFloat(glowRange.value);
        drawRibbon(trailCtx, pens[i].points, colorFor(i), w, glow);
      });

      // 合成：底圖 → 軌跡層 → 主畫布
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(ambientOn.checked && bgAlpha>0){ ctx.globalAlpha = bgAlpha; ctx.drawImage(bgCanvas, 0, 0); ctx.globalAlpha = 1; }
      ctx.drawImage(trailCanvas, 0, 0, canvas.width, canvas.height);

      // FPS
      fpsCounter();
    }

    let frames=0, lastStamp=performance.now();
    function fpsCounter(){ frames++; const t=performance.now(); if(t-lastStamp>500){ const fps=Math.round(frames*1000/(t-lastStamp)); fpsBadge.textContent='FPS: '+fps; frames=0; lastStamp=t; } }

    startBtn.addEventListener('click', async()=>{ if(running) return; running=true; await init(); loop(); });
    clearBtn.addEventListener('click', clearAll);
    saveBtn.addEventListener('click', ()=>{ const a=document.createElement('a'); a.download='color-trail-'+Date.now()+'.png'; a.href=canvas.toDataURL('image/png'); a.click(); });

    // —— 雙擊全螢幕：無任何資訊；再雙擊恢復 ——
    let clean=false;
    async function enterFullscreen(){ if(document.fullscreenElement) return; await document.documentElement.requestFullscreen().catch(()=>{}); }
    function exitFullscreen(){ if(document.fullscreenElement) document.exitFullscreen(); }
    function toggleClean(){ clean=!clean; document.body.classList.toggle('clean', clean); }
    addEventListener('dblclick', async()=>{ if(!clean){ await enterFullscreen(); toggleClean(); } else { toggleClean(); exitFullscreen(); } });

    // 快捷鍵
    addEventListener('keydown', (e)=>{ if(e.key==='c'||e.key==='C') clearAll(); if(e.key==='s'||e.key==='S') saveBtn.click(); if(e.key==='f'||e.key==='F'){ if(!clean){ enterFullscreen().then(toggleClean); } else { toggleClean(); exitFullscreen(); } } });
  </script>
</body>
</html>